<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js" type="text/javascript"></script>
    <script src="signalr/hubs"></script>
    <script type="text/javascript">
        function renderStatement(statement, container, prepend){
            console.log(statement);

            var html = '<h1>' + statement["Message"] + '</h1>';
            html += '<h3>' + statement["User"] + '</h3>';
            html += '<h5>' + statement["Timestamp"] + '</h5>';
            html += '</hr>';
            html += '</br>';

            if(prepend){
                container.prepend(html);
            }
            else{
                container.append(html);
            }
        }

        $(function () {
            $('#message-box').hide();
            console.log('Connecting to blueApp');

            //Create hub connection
            var connection = $.connection.hub;
            var blueApp = $.connection.blueApp;
            blueApp.logging = true;

            var statementsBox = $('#statements-box');

            blueApp.client.onTransmit = function (fromUserName, message) {
                console.log('Received message from ' + fromUserName + ': ' + message);

                var message = JSON.parse(message);

                var type = message.type;

                if(fromUserName == 'server' && type == 'init'){
                    var statements = message.statements;

                    for(var i = 0; i < statements.length; i++){
                        var statement = statements[i];

                        renderStatement(statement, statementsBox);
                    }
                }
                else{
                    if(type == 'statement'){
                        var statement = message.statement;

                        renderStatement(statement, statementsBox, true);
                    }
                }
            };

            //connection.url = 'http://blue-app-server.azurewebsites.net/signalr';
            console.log(connection.url);

            $('#connect').click(function(){
                connection.start()
                .done(function () {
                    console.log('Connected to signalR');

                    $('#connect-box').hide();
                    $('#message-box').show();

                    var userName = $('#username').val();
                    $.connection.$user(userName);

                    console.log('Connected as ' + userName);

                    blueApp.server.sendToUser(userName, 'server', 'init');

                    $('#sendmessage').click(function () {
                        var sendTo = $('#sendto').val();
                        var message = $('#message').val();

                        var transmission = {
                            type: 'chat',
                            message: message
                        };

                        var transmissionString = JSON.stringify(transmission);

                        console.log('Sending message from ' + userName + ' to ' + sendTo + ': ' + transmissionString);

                        //Call the hub server send
                        blueApp.server.sendToUser(userName, sendTo, message);
                    });

                    $('#broadcastMessage').click(function () {
                        var message = $('#message').val();

                        var transmission = {
                            type: 'statement',
                            statement: {
                                Message : message,
                                User : userName,
                                Timestamp: new Date()
                            }
                        };

                        var transmissionString = JSON.stringify(transmission);

                        console.log('Broadcasting statement from ' + userName + ': ' + transmissionString);

                        //Call the hub server send
                        blueApp.server.broadcast(userName, transmissionString);
                    });
                })
                .fail(function(error){
                    console.log('Could not connect');
                    console.log(error);
                });
            });
        });
    </script>
</head>
<body>
    <div id="connect-box">
        Username: <input type="text" id="username"/>
        </br>
        <input type="button" id="connect" value="Connect"/>
    </div>
    <div id="message-box">
        To: <input type="text" id="sendto"/>
        </br>
        Message : <input type="text" id="message"/>
        </br>
        <input type="button" id="sendmessage" value="Send" />
        <input type="button" id="broadcastMessage" value="Broadcast" />
    </div>

    <div id="statements-box">
    </div>
</body>
</html>
